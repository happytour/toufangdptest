<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="format-detection" content="telephone=no">
    <title>测试工具</title>
</head>

<body>
    <h1>测试工具</h1>
    <p>测试工具v10</p>
    <!--下面按钮放到一列-->
    <!--下面按钮高度变高-->
    <!--按钮之间间距变大-->
    <!-- <style>
        button {
            height: 50px;
            font-size: 16px;
        }
    </style>
    <div style="display: flex; flex-direction: column; gap: 10px;">
        <button id="mainAction">mainAction</button>
        <button id="carveRecords">carveRecords</button>
        <button id="showSharedMenu">showSharedMenu</button>
    </div> -->
    <script>
        // 存储回调函数
        const pendingCallbacks = {};
        let callbackId = 0;
        // 定义call函数
        function call(api, data, success, error, timeout) {
            const id = 'callback_' + (callbackId++);
            // 存储回调
            pendingCallbacks[id] = {
                success: success,
                error: error
            };
            // 发送到父页面
            window.parent.postMessage({
                type: 'iframe',
                callbackId: id,
                api: api,
                data: data,
                timeout: timeout
            }, '*');
        }
        // 监听父页面返回的消息
        window.addEventListener('message', function (event) {
            if (event.data && event.data.type === 'iframe') {
                const { callbackId, success, data } = event.data;
                const callback = pendingCallbacks[callbackId];
                if (callback) {
                    if (success) {
                        callback.success(data);
                    } else {
                        callback.error(data);
                    }
                    // 删除已处理的回调
                    delete pendingCallbacks[data.callbackId];
                }
            }
        });

        async function fetchMainAction() {
            return new Promise((resolve, reject) => {
                call(
                    'MtopWVPlugin.send',
                    {
                        api: "mtop.tmall.farm.gaia.base.new.extra.set.security",
                        data: {
                            bizCode: "Bargaining",
                            params: JSON.stringify({
                                action: "mainAction",
                                hdFrom: "farm_main_kkj"
                            }),
                            asac: "2A247225H5RHA0R0BPN6HG"
                        },
                        v: "1.0",
                        type: "originaljson",
                        ecode: 0,
                        timeout: 5000,
                        needLogin: false,
                        isSec: 1,
                        secType: 2,
                        key: "bargain.mainAction",
                        preventFallback: true,
                        param: {
                            bizCode: "Bargaining",
                            params: JSON.stringify({
                                action: "mainAction",
                                hdFrom: "farm_main_kkj"
                            }),
                            asac: "2A247225H5RHA0R0BPN6HG"
                        },
                        sessionOption: "AutoLoginOnly"
                    },
                    result => resolve(result),
                    error => reject(error),
                    5000
                );
            });
        }

        async function fetchCarveRecords(pageNum = 1, pageSize = 20) {
            return new Promise((resolve, reject) => {
                call(
                    'MtopWVPlugin.send',
                    {
                        api: "mtop.tmall.farm.gaia.base.new.extra.set",
                        data: {
                            bizCode: "Bargaining",
                            params: JSON.stringify({
                                action: "carveRecords",
                                pageNum,
                                pageSize
                            })
                        },
                        v: "1.0",
                        type: "originaljson",
                        ecode: 0,
                        timeout: 5000,
                        needLogin: false,
                        preventFallback: true,
                        param: {
                            bizCode: "Bargaining",
                            params: JSON.stringify({
                                action: "carveRecords",
                                pageNum,
                                pageSize
                            })
                        },
                        sessionOption: "AutoLoginOnly"
                    },
                    result => resolve(result),
                    error => reject(error),
                    5000
                );
            });
        }

        async function getCurrentPriceAndCarveSum() {
            try {
                // 获取 currentPriceYuan
                const mainActionRes = await fetchMainAction();
                if (!mainActionRes || !mainActionRes.data || !mainActionRes.data.goodInfo) {
                    throw new Error("mainAction接口返回异常");
                }
                const currentPriceYuan = mainActionRes.data.goodInfo.currentPriceYuan;
                await new Promise(resolve => setTimeout(resolve, 500));
                // 获取砍价记录总和
                let pageNum = 1;
                let pageSize = 20;
                let hasMore = true;
                let total = 0;
                while (hasMore) {
                    //这里添加0.2秒-08秒的延时，防止请求过快导致接口异常
                    await new Promise(resolve => setTimeout(resolve, 200 + Math.random() * 600));
                    const carveRes = await fetchCarveRecords(pageNum, pageSize);
                    if (!carveRes || !carveRes.data) {
                        throw new Error("carveRecords接口返回异常");
                    }
                    const { records = [], hasMore: more } = carveRes.data;
                    total += records.length;
                    hasMore = more;
                    pageNum += 1;
                }
                return { currentPriceYuan: currentPriceYuan, carveSum: total };
            } catch (err) {
                return null;
            }
        }
        // 使用示例
        getCurrentPriceAndCarveSum().then(result => {
            if (result) {
                copyAndGotoWeixin("余额：" + result.currentPriceYuan + '；砍价记录数：' + result.carveSum);
            } else {
                alert("获取数据失败");
            }
        });

        function copyAndGotoWeixin(text) {
            call(
                'Base.copyToClipboard',
                {
                    "text": text
                },
                function (result) {
                    call('WVUIToast.toast',
                        {
                            "message": "已复制到剪切板，正在打开微信",
                            "duration": 2000
                        },
                        function (result) {
                            call(
                                'TBSharedModule.openApp',
                                { "packageName": "com.tencent.mm" },
                                function (result) {
                                    // alert('Success: ' + JSON.stringify(result));
                                },
                                function (error) {
                                    alert('Error: ' + JSON.stringify(error));
                                },
                                5000
                            );
                        },
                        function (error) {
                            alert('Error: ' + JSON.stringify(error));
                        },
                        5000
                    );
                },
                function (error) {
                    alert('Error: ' + JSON.stringify(error));
                },
                5000
            );
        };
    </script>
</body>

</html>
